<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sales Tracker</title>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Segoe UI',sans-serif;background:#0f172a;color:#e2e8f0;min-height:100vh;}
button,input,select{font-family:inherit;}
.header{background:linear-gradient(135deg,#1e3a5f,#0f2942);padding:20px 24px;border-bottom:1px solid #1e40af;}
.header h1{font-size:22px;font-weight:700;color:#60a5fa;}
.header p{font-size:12px;color:#94a3b8;margin-top:2px;}
.tabs{display:flex;background:#1e293b;border-bottom:1px solid #334155;overflow-x:auto;}
.tab-btn{padding:12px 16px;border:none;cursor:pointer;font-size:12px;font-weight:600;white-space:nowrap;background:transparent;color:#94a3b8;border-bottom:2px solid transparent;}
.tab-btn.active{background:#1e40af;color:#fff;border-bottom:2px solid #60a5fa;}
.content{padding:20px 24px;max-width:960px;margin:0 auto;}
.card{background:#1e293b;border-radius:12px;padding:16px;border:1px solid #334155;margin-bottom:12px;}
.card-dark{background:#0f172a;border-radius:12px;padding:16px;border:1px solid #334155;margin-bottom:12px;}
.lbl{font-size:12px;color:#94a3b8;display:block;margin-bottom:4px;}
.inp{width:100%;padding:9px 12px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:14px;}
.sel{width:100%;padding:9px 12px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:14px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.btn-pri{padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#1d4ed8,#2563eb);color:#fff;font-size:14px;font-weight:700;cursor:pointer;width:100%;}
.btn-sm{padding:5px 14px;border-radius:6px;border:1px solid #1d4ed8;background:#1e3a5f;color:#93c5fd;font-size:12px;font-weight:600;cursor:pointer;}
.btn-del{background:#7f1d1d;border:none;border-radius:6px;padding:4px 10px;color:#fca5a5;font-size:12px;cursor:pointer;}
.btn-rider{padding:4px 12px;border-radius:6px;border:1px solid #4f46e5;background:#1e1b4b;color:#a5b4fc;font-size:11px;font-weight:600;cursor:pointer;}
.pol-block{background:#0f172a;border-radius:12px;padding:16px;border:1px solid #1e40af;margin-bottom:12px;}
.rider-block{background:#0a1929;border-radius:8px;padding:12px;border:1px solid #4f46e5;margin-bottom:8px;}
.prev-box{margin-top:12px;background:#0f2942;border-radius:10px;padding:12px;border:1px solid #1e40af;}
.mc{text-align:center;background:#0a1929;border-radius:6px;padding:6px 2px;}
.mc .ml{font-size:10px;color:#64748b;}
.mc .mv{font-size:13px;font-weight:700;margin-top:1px;}
.prog-wrap{background:#0f172a;border-radius:8px;height:14px;overflow:hidden;margin:6px 0;}
.prog-bar{height:100%;border-radius:8px;transition:width 0.5s;}
.kpi{font-size:18px;font-weight:800;margin-top:4px;}
.pay-card{background:linear-gradient(135deg,#1e3a5f,#0f2942);border-radius:12px;padding:18px;border:1px solid #1e40af;margin-bottom:16px;text-align:center;}
.camp-hdr{background:linear-gradient(135deg,#1e3a5f,#0f2942);padding:16px 20px;border-bottom:1px solid #1e40af;}
.camp-card{background:#1e293b;border-radius:16px;border:1px solid #334155;overflow:hidden;margin-bottom:20px;}
.yr-btn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;border:1px solid #0d9488;background:linear-gradient(135deg,#0f766e,#134e4a);color:#5eead4;font-size:13px;font-weight:700;cursor:pointer;}
.yr-dd{position:absolute;top:calc(100% + 6px);left:0;z-index:999;background:#1e293b;border:1px solid #0d9488;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,0.5);min-width:110px;max-height:240px;overflow-y:auto;}
.yr-opt{display:block;width:100%;padding:9px 16px;border:none;cursor:pointer;font-size:13px;text-align:left;font-family:inherit;}
.q-btn{flex:1;min-width:60px;padding:8px 0;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;border:1px solid #334155;background:#1e293b;color:#94a3b8;}
.q-btn.active{background:#1d4ed8;color:#fff;border-color:#3b82f6;}
.hist-item{background:#1e293b;border-radius:12px;padding:16px;border:1px solid #334155;margin-bottom:12px;}
.pol-row{background:#0f172a;border-radius:8px;padding:10px;border:1px solid #1e3a5f;margin-bottom:6px;}
.badge{background:#0f2942;border-radius:4px;padding:2px 8px;font-size:11px;color:#60a5fa;}
.t-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
/* Calendar */
.cal-wrap{position:relative;}
.cal-row{display:flex;gap:6px;}
.cal-ico{padding:9px 13px;border-radius:8px;border:1px solid #334155;background:#0f172a;cursor:pointer;font-size:16px;color:#60a5fa;}
.cal-ico.open{background:#1d4ed8;color:#fff;}
.cal-pop{position:absolute;z-index:999;top:calc(100% + 6px);left:0;background:#1e293b;border:1px solid #334155;border-radius:12px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,0.6);min-width:265px;}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.cal-nb{background:#334155;border:none;border-radius:6px;padding:4px 12px;color:#e2e8f0;cursor:pointer;font-size:15px;}
.cal-ysel{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:3px 6px;color:#60a5fa;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;}
.cal-dh{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px;}
.cal-dh span{text-align:center;font-size:11px;color:#64748b;font-weight:600;padding:2px 0;}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day{padding:6px 2px;border:none;border-radius:6px;cursor:pointer;font-size:12px;background:transparent;color:#e2e8f0;font-family:inherit;}
.cal-day.empty{cursor:default;color:transparent;}
.cal-day.today{color:#60a5fa;outline:1px solid #334155;}
.cal-day.selected{background:#1d4ed8!important;color:#fff!important;font-weight:700;}
.cal-tod{margin-top:8px;width:100%;padding:7px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#60a5fa;font-size:12px;cursor:pointer;font-weight:600;font-family:inherit;}
/* Searchable dropdown */
.srch-wrap{position:relative;}
.srch-inp{width:100%;padding:9px 12px;border-radius:8px;border:1px solid #3b82f6;background:#0f172a;color:#e2e8f0;font-size:14px;outline:none;}
.srch-list{position:absolute;z-index:9999;top:calc(100% + 4px);left:0;right:0;background:#1e293b;border:1px solid #334155;border-radius:10px;max-height:260px;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.6);}
.srch-cat{padding:5px 12px;font-size:10px;font-weight:800;letter-spacing:0.08em;text-transform:uppercase;cursor:default;}
.srch-cat.ct{background:rgba(30,64,175,0.30);color:#93c5fd;}
.srch-cat.ci{background:rgba(109,40,217,0.30);color:#c4b5fd;}
.srch-cat.ch{background:rgba(5,150,105,0.25);color:#6ee7b7;}
.srch-item{padding:8px 16px;font-size:13px;color:#e2e8f0;cursor:pointer;border-left:3px solid transparent;}
.srch-item:hover{background:#0f2942;border-left-color:#3b82f6;}
.srch-sel{display:flex;align-items:center;justify-content:space-between;width:100%;padding:9px 12px;border-radius:8px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;font-size:13px;cursor:pointer;text-align:left;}
.srch-sel:hover{border-color:#3b82f6;}
.srch-ph{color:#64748b;}
</style>
</head>
<body>
<div class="header">
  <h1>ğŸ“Š Sales Commission Tracker</h1>
  <p>Income Financial Consultant Â· Singapore</p>
</div>
<div class="tabs" id="tabBar"></div>
<div class="content" id="app"></div>
<canvas id="confetti" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:99999;display:none;"></canvas>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const FB = {
  apiKey:"AIzaSyB1rNNjgnpI6p6xYFxdXCD-k8sdq2SHoBw",
  authDomain:"zack-comms-tracker-iafa.firebaseapp.com",
  projectId:"zack-comms-tracker-iafa",
  storageBucket:"zack-comms-tracker-iafa.firebasestorage.app",
  messagingSenderId:"889861149236",
  appId:"1:889861149236:web:8488f5336ab9d2475bb061"
};
const db = getFirestore(initializeApp(FB));
const COLL = "sales";

// â”€â”€ Product categories for searchable dropdown â”€â”€
const CATS = [
  { label:"Traditional Life Insurance", hCls:"srch-cat ct", iCls:"srch-item", products:[
    "Mortgage Term (MPN2)","Star Term Protect (TAN19)","TermLife Solitaire (TBN3)",
    "Essential Protect (LBV3)","Complete Life Secure (VQMW)",
    "Complete Life Secure - Protection Benefit (VQVW)","Total Protect (TPV1)",
    "Complete Cancer Care (CBN3)","Complete Critical Protect (CCN1)",
    "Advanced Critical Secure (CSV10)","Early Critical Secure (CSV11)",
    "Cancer Premium Waiver / GIO (WPV10)","Payor Premium Waiver (WPV6)",
    "Enhanced Payor Premium Waiver (WEV2)","Dread Disease Premium Waiver (WSV2)",
    "Hospital CashAid (HBV3)","Lady 360 (LPN)","Maternity 360 (MBN)",
    "Gro Power Saver Pro (RSME)","Gro Saver Flex Pro (GSME)","Gro Cash Flex Pro (GCME)",
    "Gro Cash Plus (GDMW)","Gro Cash Sure (GCMW)","Savings Protector Pro (SPV3)",
    "Gro Retire Flex Pro (GRME)","Gro Retire Flex Pro - Protection Benefit (SPV4)",
    "Gro Annuity Pro (GAMA)","Provenance Solitaire (VPMW)",
    "Provenance Solitaire - Protection Benefit (VPVW)",
    "Provenance Disability Accelerator (TSN3)",
    "Luxe Plus Solitaire II (LTMW)","Wealth Plus Solitaire (LHMWA)"
  ]},
  { label:"Investment Linked Insurance", hCls:"srch-cat ci", iCls:"srch-item", products:[
    "AstraLink (VA2)","Invest Flex (VS1)","Invest Flex Vantage (VS2)",
    "Invest Flex TriVantage (VS3)","WealthLink (GL3)"
  ]},
  { label:"Health Insurance", hCls:"srch-cat ch", iCls:"srch-item", products:[
    "Enhanced IncomeShield / IncomeShield Standard","PrimeShield","Care Secure"
  ]}
];

// â”€â”€ Products â”€â”€
const PROD = {
  "Mortgage Term (MPN2)":{terms:[{l:"3 years",y:10.50,c:3},{l:"4 years",y:11.50,c:3},{l:"5 years",y:12.50,c:3},{l:"6-9 years",y:13.00,c:3},{l:"10-14 years",y:18.00,c:3},{l:"15-19 years",y:26.00,c:3},{l:"20+ years",y:40.00,c:3}]},
  "Star Term Protect (TAN19)":{riders:["Essential Protect (LBV3)","Total Protect (TPV1)"],terms:[{l:"5 years",y:12.50,c:3},{l:"6-9 years",y:13.00,c:3},{l:"10-14 years",y:18.00,c:3},{l:"15-19 years",y:26.00,c:3},{l:"20-24 years",y:40.00,c:3},{l:"25+ years",y:40.00,c:3}]},
  "TermLife Solitaire (TBN3)":{riders:["Disability Accelerator (TCN2)","Essential Protect (LBV3)","Total Protect (TPV1)"],terms:[{l:"6-9 years",y:13.00,c:3},{l:"10-14 years",y:18.00,c:3},{l:"15-19 years",y:26.00,c:3},{l:"20-24 years",y:41.20,c:3},{l:"25+ years",y:45.50,c:3}]},
  "Essential Protect (LBV3)":{terms:[{l:"5 years",y:12.50,c:4},{l:"6-9 years",y:13.00,c:4},{l:"10-14 years",y:18.00,c:4},{l:"15-19 years",y:26.00,c:4},{l:"20+ years",y:40.00,c:4}]},
  "Complete Life Secure (VQMW)":{terms:[{l:"5 years",y:10.00,c:4},{l:"6-9 years",y:10.20,c:4},{l:"10-14 years",y:22.00,c:4},{l:"15-19 years",y:33.00,c:4},{l:"20-24 years",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Complete Life Secure - Protection Benefit (VQVW)":{terms:[{l:"5 years",y:10.00,c:4},{l:"6-9 years",y:10.20,c:4},{l:"10-14 years",y:22.00,c:4},{l:"15-19 years",y:33.00,c:4},{l:"20-24 years",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Total Protect (TPV1)":{terms:[{l:"5 years",y:12.50,c:4},{l:"6-9 years",y:13.00,c:4},{l:"10-14 years",y:18.00,c:4},{l:"15-19 years",y:26.00,c:4},{l:"20+ years",y:40.00,c:4}]},
  "Complete Cancer Care (CBN3)":{terms:[{l:"10 years",y:22.00,c:4}]},
  "Complete Critical Protect (CCN1)":{terms:[{l:"10-14 years",y:22.00,c:4},{l:"15-19 years",y:33.00,c:4},{l:"20-24 years",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Advanced Critical Secure (CSV10)":{terms:[{l:"5 years",y:10.00,c:4},{l:"6-9 years",y:10.20,c:4},{l:"10-14 years",y:22.00,c:4},{l:"15-19 years",y:33.00,c:4},{l:"20-24 years",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Early Critical Secure (CSV11)":{terms:[{l:"5 years",y:10.00,c:4},{l:"6-9 years",y:10.20,c:4},{l:"10-14 years",y:22.00,c:4},{l:"15-19 years",y:33.00,c:4},{l:"20-24 years",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Cancer Premium Waiver / GIO (WPV10)":{terms:[{l:"All Terms",y:20.00,c:4}]},
  "Payor Premium Waiver (WPV6)":{terms:[{l:"All Terms",y:20.00,c:4}]},
  "Enhanced Payor Premium Waiver (WEV2)":{terms:[{l:"All Terms",y:20.00,c:4}]},
  "Dread Disease Premium Waiver (WSV2)":{terms:[{l:"All Terms",y:20.00,c:4}]},
  "Hospital CashAid (HBV3)":{terms:[{l:"All Terms",y:4.00,c:4}]},
  "Lady 360 (LPN)":{terms:[{l:"All Terms",y:4.00,c:4}]},
  "Maternity 360 (MBN)":{terms:[{l:"Single",y:5.00,c:1}]},
  "Gro Power Saver Pro (RSME)":{terms:[{l:"3 years",y:3.30,c:0.30}]},
  "Gro Saver Flex Pro (GSME)":{terms:[{l:"Single",y:3.00,c:1}]},
  "Gro Cash Flex Pro (GCME)":{terms:[{l:"Single",y:3.00,c:1}]},
  "Gro Cash Plus (GDMW)":{terms:[{l:"5 years",y:11.50,c:1},{l:"10 years",y:18.30,c:1}]},
  "Gro Cash Sure (GCMW)":{terms:[{l:"5yr (Policy >10 <=25)",y:9.00,c:0.60},{l:"5yr (Policy >25)",y:10.00,c:0.60},{l:"10yr (Policy <=25)",y:18.20,c:0.60},{l:"10yr (Policy >25)",y:22.00,c:0.60},{l:"15yr (Policy >25)",y:33.00,c:0.60},{l:"20yr (Policy >25)",y:44.00,c:1.00},{l:"25+ years",y:55.00,c:1.00}]},
  "Savings Protector Pro (SPV3)":{terms:[{l:"1yr (Policy <=10)",y:2.00,c:4},{l:"2yr (Policy <=10)",y:2.20,c:4},{l:"3yr (Policy <=10)",y:3.30,c:4},{l:"4yr (Policy <=10)",y:4.40,c:4},{l:"5yr (Policy <=10)",y:5.50,c:4},{l:"5yr (Policy >10 <=25)",y:9.00,c:4},{l:"5yr (Policy >25)",y:10.00,c:4},{l:"10yr (Policy <=25)",y:18.20,c:4},{l:"10yr (Policy >25)",y:22.00,c:4},{l:"15yr (Policy <=25)",y:27.20,c:4},{l:"15yr (Policy >25)",y:33.00,c:4},{l:"20yr (Policy <=25)",y:36.30,c:4},{l:"20yr (Policy >25)",y:44.00,c:4},{l:"25+ years",y:55.00,c:4}]},
  "Gro Retire Flex Pro (GRME)":{terms:[{l:"Single",y:3.50,c:1.00},{l:"5yr (Policy <=10)",y:5.50,c:0.60},{l:"5yr (Policy >10 <=25)",y:9.00,c:0.60},{l:"5yr (Policy >25)",y:10.00,c:0.60},{l:"10yr (Policy <=25)",y:18.20,c:0.60},{l:"10yr (Policy >25)",y:22.00,c:0.60},{l:"15yr (Policy <=25)",y:27.20,c:0.60},{l:"15yr (Policy >25)",y:33.00,c:1.00},{l:"20yr (Policy <=25)",y:36.30,c:1.00},{l:"20yr (Policy >25)",y:44.00,c:1.00},{l:"25+ years",y:55.00,c:1.00}]},
  "Gro Retire Flex Pro - Protection Benefit (SPV4)":{terms:[{l:"5yr (Policy <=10)",y:5.50,c:0.60},{l:"5yr (Policy >10 <=25)",y:9.00,c:0.60},{l:"5yr (Policy >25)",y:10.00,c:0.60},{l:"10yr (Policy <=25)",y:18.20,c:0.60},{l:"10yr (Policy >25)",y:22.00,c:0.60},{l:"15yr (Policy <=25)",y:27.20,c:0.60},{l:"15yr (Policy >25)",y:33.00,c:1.00},{l:"20yr (Policy <=25)",y:36.30,c:1.00},{l:"20yr (Policy >25)",y:44.00,c:1.00},{l:"25+ years",y:55.00,c:1.00}]},
  "Gro Annuity Pro (GAMA)":{terms:[{l:"Single",y:1.00,c:0}]},
  "Provenance Solitaire (VPMW)":{terms:[{l:"Single",y:5.50,c:1}]},
  "Provenance Solitaire - Protection Benefit (VPVW)":{terms:[{l:"Single",y:5.50,c:1}]},
  "Provenance Disability Accelerator (TSN3)":{terms:[{l:"Single",y:5.50,c:1}]},
  "Luxe Plus Solitaire II (LTMW)":{terms:[{l:"Single",y:3.25,c:1}]},
  "Wealth Plus Solitaire (LHMWA)":{terms:[{l:"Single",y:3.00,c:1}]},
  "AstraLink (VA2)":{terms:[{l:"MIP 10yr",y:22.00,c:4},{l:"MIP 15yr",y:33.00,c:4},{l:"MIP 20yr",y:44.00,c:4},{l:"MIP 25yr",y:55.00,c:4}]},
  "Invest Flex (VS1)":{terms:[{l:"5yr (All Policy Term)",y:3.85,c:1.50},{l:"10yr (All Policy Term)",y:23.95,c:2.50},{l:"15yr (All Policy Term)",y:48.55,c:3.00},{l:"20yr (All Policy Term)",y:52.35,c:3.00}]},
  "Invest Flex Vantage (VS2)":{terms:[{l:"5yr (All Policy Term)",y:2.60,c:1.50},{l:"10yr (All Policy Term)",y:23.00,c:2.50},{l:"15yr (All Policy Term)",y:44.20,c:3.00},{l:"20yr (All Policy Term)",y:46.00,c:3.00}]},
  "Invest Flex TriVantage (VS3)":{terms:[{l:"10yr (All Policy Term)",y:11.00,c:1.50}]},
  "WealthLink (GL3)":{terms:[{l:"Single",y:1.50,c:0}]},
  "Enhanced IncomeShield / IncomeShield Standard":{riders:["Classic Care Rider","Deluxe Care Rider"],terms:[{l:"Yearly",y:30.00,c:4}]},
  "PrimeShield":{terms:[{l:"Yearly",y:35.00,c:4}]},
  "Care Secure":{terms:[{l:"Yearly",y:45.00,c:4}]}
};

// â”€â”€ Rider term-based rates (each rider selects its OWN term independently) â”€â”€
const RIDER_TERMS = {
  "Disability Accelerator (TCN2)":[
    {l:"6-9 years",y:13.00,c:3},
    {l:"10-14 years",y:18.00,c:3},
    {l:"15-19 years",y:26.00,c:3},
    {l:"20-24 years",y:41.20,c:3},
    {l:"25+ years",y:45.50,c:3}
  ],
  "Essential Protect (LBV3)":[
    {l:"5 years",y:12.50,c:4},
    {l:"6-9 years",y:13.00,c:4},
    {l:"10-14 years",y:18.00,c:4},
    {l:"15-19 years",y:26.00,c:4},
    {l:"20+ years",y:40.00,c:4}
  ],
  "Total Protect (TPV1)":[
    {l:"5 years",y:12.50,c:4},
    {l:"6-9 years",y:13.00,c:4},
    {l:"10-14 years",y:18.00,c:4},
    {l:"15-19 years",y:26.00,c:4},
    {l:"20+ years",y:40.00,c:4}
  ],
  "Classic Care Rider":[{l:"Yearly",y:15.00,c:4}],
  "Deluxe Care Rider":[{l:"Yearly",y:15.00,c:4}]
};

function getRiderRate(riderName, riderTerm) {
  const terms = RIDER_TERMS[riderName];
  if (!terms) return null;
  // For single-term riders like Classic/Deluxe, always use first entry
  if (terms.length === 1) return {y:terms[0].y, c:terms[0].c};
  // For multi-term riders, match the selected term
  const found = terms.find(t => t.l === riderTerm);
  return found ? {y:found.y, c:found.c} : null;
}

const QS = {
  Q1:{months:[0,1,2],label:"Q1 (Jan-Mar)",payout:"April"},
  Q2:{months:[3,4,5],label:"Q2 (Apr-Jun)",payout:"July"},
  Q3:{months:[6,7,8],label:"Q3 (Jul-Sep)",payout:"October"},
  Q4:{months:[9,10,11],label:"Q4 (Oct-Dec)",payout:"January"}
};
const TIERS = [
  {min:0,max:49999,bonus:0,label:"< 50,000"},
  {min:50000,max:67999,bonus:10,label:"50,000 - 67,999"},
  {min:68000,max:96999,bonus:20,label:"68,000 - 96,999"},
  {min:97000,max:139999,bonus:30,label:"97,000 - 139,999"},
  {min:140000,max:Infinity,bonus:40,label:"140,000+"}
];
const MTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

// â”€â”€ Helpers â”€â”€
const $f = n => "$"+n.toLocaleString("en-SG",{minimumFractionDigits:2,maximumFractionDigits:2});
const $c = n => n.toLocaleString("en-SG",{minimumFractionDigits:0,maximumFractionDigits:0});
const uid = () => Date.now().toString(36)+Math.random().toString(36).slice(2);
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
const todayStr = () => { const t=new Date(); return t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0"); };
const getQ = m => { for(const [k,v] of Object.entries(QS)) if(v.months.includes(m)) return k; };
const getTier = c => TIERS.find(t=>c>=t.min&&c<=t.max)||TIERS[0];
const yearList = () => { const y=[],cur=new Date().getFullYear(); for(let i=cur;i>=2020;i--) y.push(i); return y; };

// â”€â”€ State â”€â”€
let sales=[], tab="log", activeQ="Q1", selYear=new Date().getFullYear();
let pols=[newPol()], fDate=todayStr(), fClient="";
let calOpen=false, calY=new Date().getFullYear(), calM=new Date().getMonth();
let srch={};

function newPol(){ return {id:uid(),product:"",term:"",ap:"",riders:[]}; }
function newRider(){ return {id:uid(),name:"",riderTerm:"",premium:""}; }

// â”€â”€ Firebase â”€â”€
onSnapshot(collection(db,COLL), snap=>{
  sales=[];
  snap.forEach(d=>sales.push({...d.data(),fid:d.id}));
  sales.sort((a,b)=>a.date<b.date?1:-1);
  renderAll();
});
async function addSaleDB(obj){ try{ await addDoc(collection(db,COLL),obj); }catch(e){ alert("Save error: "+e.message); } }
async function delSaleDB(fid){ try{ await deleteDoc(doc(db,COLL,fid)); }catch(e){ alert("Delete error: "+e.message); } }

// â”€â”€ Render â”€â”€
function renderAll(){ renderTabs(); renderPage(); }

function renderTabs(){
  const tabs=[["log","â• Log Sale"],["dashboard","ğŸ“ˆ Dashboard"],["history","ğŸ“‹ All Sales"],["ignite","ğŸ”¥ Ignite 2026"],["trail","ğŸŒ Trailblazer 2027"]];
  document.getElementById("tabBar").innerHTML=tabs.map(([k,v])=>
    "<button class='tab-btn"+(tab===k?" active":"")+"' onclick='setTab(\""+k+"\")'>"+v+"</button>"
  ).join("");
}

function renderPage(){
  const el=document.getElementById("app");
  if(tab==="log"){ if(!document.getElementById("logShell")) el.innerHTML="<div id='logShell'></div>"; renderLog(); }
  else if(tab==="dashboard") el.innerHTML=renderDash();
  else if(tab==="history")   el.innerHTML=renderHist();
  else if(tab==="ignite")    el.innerHTML=renderIgnite();
  else                       el.innerHTML=renderTrail();
  attachAll();
}

// â”€â”€ LOG â”€â”€
function renderLog(){
  const shell=document.getElementById("logShell");
  if(shell) shell.innerHTML=buildLog();
}

function buildLog(){
  const gt=grandTot();
  return "<div style='font-size:16px;font-weight:700;margin-bottom:16px;color:#60a5fa;'>Log a New Sale</div>"
  +"<div class='card'>"
  +"<div class='g2' style='margin-bottom:20px;'>"
  +"<div><label class='lbl'>ğŸ“… Date of Sale</label>"+buildCal()+"</div>"
  +"<div><label class='lbl'>ğŸ‘¤ Client Name</label><input class='inp' id='clientInp' type='text' placeholder='e.g. John Tan' value='"+esc(fClient)+"'/></div>"
  +"</div>"
  +"<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>"
  +"<span style='font-size:13px;font-weight:700;color:#60a5fa;'>ğŸ“„ Policies ("+pols.length+")</span>"
  +"<button class='btn-sm' onclick='addPol()'>+ Add Policy</button>"
  +"</div>"
  +pols.map((p,i)=>buildPolBlock(p,i)).join("")
  +(gt.comm>0
    ?"<div class='prev-box' style='margin-bottom:14px;'><div style='font-size:12px;color:#60a5fa;font-weight:700;margin-bottom:8px;'>ğŸ§® Grand Total</div>"
    +"<div class='g2'>"
    +"<div class='mc' style='padding:10px 4px;'><div class='ml'>Total Commission</div><div style='font-size:18px;font-weight:800;color:#34d399;margin-top:2px;'>"+$f(gt.comm)+"</div></div>"
    +"<div class='mc' style='padding:10px 4px;'><div class='ml'>Total Credits</div><div style='font-size:18px;font-weight:800;color:#60a5fa;margin-top:2px;'>"+$c(gt.cred)+" pts</div></div>"
    +"</div></div>" :"")
  +"<button class='btn-pri' onclick='doAddSale()'>âœ… Add Sale</button>"
  +"</div>";
}

function buildCal(){
  const sd=fDate?new Date(fDate+"T00:00:00"):null;
  const disp=sd?sd.toLocaleDateString("en-SG",{day:"2-digit",month:"short",year:"numeric"}):"";
  return "<div class='cal-wrap' id='calWrap'>"
  +"<div class='cal-row'><input class='inp' id='dateInp' type='text' placeholder='YYYY-MM-DD' value='"+fDate+"' style='flex:1;'/>"
  +"<button class='cal-ico"+(calOpen?" open":"")+"' id='calIco'>ğŸ“…</button></div>"
  +(disp?"<div style='font-size:11px;color:#64748b;margin-top:3px;'>"+disp+"</div>":"")
  +(calOpen?buildCalPop():"")+"</div>";
}

function buildCalPop(){
  const today=new Date();
  const first=new Date(calY,calM,1).getDay();
  const dim=new Date(calY,calM+1,0).getDate();
  const sd=fDate?new Date(fDate+"T00:00:00"):null;
  let cells="";
  for(let i=0;i<first;i++) cells+="<button class='cal-day empty' disabled></button>";
  for(let d=1;d<=dim;d++){
    const isSel=sd&&sd.getFullYear()===calY&&sd.getMonth()===calM&&sd.getDate()===d;
    const isTod=today.getFullYear()===calY&&today.getMonth()===calM&&today.getDate()===d;
    cells+="<button class='cal-day"+(isSel?" selected":isTod?" today":"")+"' onclick='pickDay("+d+")'>"+d+"</button>";
  }
  const yOpts=yearList().map(y=>"<option value='"+y+"'"+(y===calY?" selected":"")+">"+y+"</option>").join("");
  return "<div class='cal-pop' id='calPop'>"
  +"<div class='cal-nav'><button class='cal-nb' onclick='navM(-1)'>&#8249;</button>"
  +"<div style='display:flex;align-items:center;gap:6px;'>"
  +"<span style='font-weight:700;font-size:13px;color:#60a5fa;'>"+MTHS[calM]+"</span>"
  +"<select class='cal-ysel' onchange='jumpY(parseInt(this.value))'>"+yOpts+"</select></div>"
  +"<button class='cal-nb' onclick='navM(1)'>&#8250;</button></div>"
  +"<div class='cal-dh'>"+["Su","Mo","Tu","We","Th","Fr","Sa"].map(d=>"<span>"+d+"</span>").join("")+"</div>"
  +"<div class='cal-days'>"+cells+"</div>"
  +"<button class='cal-tod' onclick='pickToday()'>ğŸ“Œ Today</button>"
  +"</div>";
}

function buildSrch(pid, sel){
  const s=srch[pid]||{open:false,query:""};
  const q=s.query.toLowerCase();
  const filtered=q ? CATS.map(cat=>({...cat,products:cat.products.filter(p=>p.toLowerCase().includes(q))})).filter(cat=>cat.products.length>0) : CATS;
  if(!s.open) return "<div class='srch-wrap' id='srch-"+pid+"'><button class='srch-sel' onclick='srchOpen(\""+pid+"\")'><span class='"+(sel?"":"srch-ph")+"'>"+(sel?esc(sel):"-- Select Product --")+"</span><span style='color:#64748b;font-size:11px;'>&#9660;</span></button></div>";
  return "<div class='srch-wrap' id='srch-"+pid+"'>"
  +"<input class='srch-inp' id='sinp-"+pid+"' type='text' placeholder='ğŸ” Type to search...' value='"+esc(s.query)+"' oninput='srchType(\""+pid+"\",this.value)' onkeydown='srchKey(event,\""+pid+"\")' autocomplete='off'/>"
  +(filtered.length>0
    ?"<div class='srch-list'>"+filtered.map(cat=>
        "<div class='"+cat.hCls+"'>"+cat.label+"</div>"
        +cat.products.map(p=>"<div class='"+cat.iCls+"' onclick='srchPick(\""+pid+"\",\""+esc(p)+"\")'>"+esc(p)+"</div>").join("")
      ).join("")+"</div>"
    :"<div class='srch-list'><div style='padding:12px;font-size:13px;color:#64748b;'>No products found</div></div>")
  +"</div>";
}

function buildPolBlock(b,i){
  const def=PROD[b.product]||null;
  const terms=def?def.terms:[];
  const avR=def&&def.riders?def.riders:[];
  const selT=terms.find(t=>t.l===b.term)||null;
  const ap=parseFloat(b.ap)||0;
  const chosen=b.riders.map(r=>r.name).filter(Boolean);

  // Calculate rider commissions using RIDER_TERMS (independent per rider)
  const rC=b.riders.map(r=>{
    const rd=getRiderRate(r.name, r.riderTerm);
    const rp=parseFloat(r.premium)||0;
    return {...r, rp, comm:rd&&rp?rp*rd.y/100:0, cred:rd&&rp?rp*rd.c:0, pct:rd?rd.y:0};
  });
  const bc=selT&&ap?ap*selT.y/100:0;
  const bCr=selT&&ap?ap*selT.c:0;
  const rComm=rC.reduce((a,r)=>a+r.comm,0);
  const rCred=rC.reduce((a,r)=>a+r.cred,0);
  const hasR=rC.some(r=>r.name&&r.rp>0);

  let html="<div class='pol-block'>"
  +"<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;'>"
  +"<span style='font-size:13px;font-weight:700;color:#60a5fa;'>ğŸ“‹ Policy "+(i+1)+"</span>"
  +(pols.length>1?"<button class='btn-del' onclick='remPol(\""+b.id+"\")'>âœ• Remove</button>":"")
  +"</div>"
  +"<div class='g2' style='margin-bottom:12px;'>"
  +"<div><label class='lbl'>ğŸ·ï¸ Base Product</label>"+buildSrch(b.id,b.product)+"</div>"
  +"<div><label class='lbl'>ğŸ“† Premium Term</label>"
  +"<select class='sel' style='color:"+(b.term?"#e2e8f0":"#64748b")+";opacity:"+(b.product?1:0.4)+"' "+(b.product?"":"disabled")+" onchange='updPolF(\""+b.id+"\",\"term\",this.value)'>"
  +"<option value=''>-- Select Term --</option>"
  +terms.map(t=>"<option value='"+esc(t.l)+"'"+(b.term===t.l?" selected":"")+">"+esc(t.l)+"</option>").join("")
  +"</select></div></div>"
  +"<div style='margin-bottom:12px;'><label class='lbl'>ğŸ’° Annual Premium (SGD)</label>"
  +"<input class='inp pp-inp' type='number' data-pid='"+b.id+"' placeholder='e.g. 12000' value='"+esc(b.ap)+"'/></div>";

  // Riders section
  html+="<div style='border-top:1px solid #1e3a5f;padding-top:12px;'>"
  +"<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;'>"
  +"<span style='font-size:12px;font-weight:700;color:#a78bfa;'>ğŸ”— Riders</span>"
  +(avR.length>0&&b.riders.length<avR.length
    ?"<button class='btn-rider' onclick='addRider(\""+b.id+"\")'>+ Add Rider</button>"
    :"<span style='font-size:11px;color:#475569;'>"+(avR.length===0?"No riders for this product":"All riders added")+"</span>")
  +"</div>"
  +(b.riders.length===0&&avR.length>0?"<div style='font-size:11px;color:#475569;font-style:italic;margin-bottom:8px;'>Click \"+ Add Rider\" to attach riders.</div>":"");

  b.riders.forEach((row,ri)=>{
    const avail=avR.filter(r=>r===row.name||!chosen.includes(r));
    const rTerms=RIDER_TERMS[row.name]||null;
    const needsTerm=rTerms&&rTerms.length>1; // only show term picker if multiple options

    html+="<div class='rider-block'>"
    +"<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;'>"
    +"<span style='font-size:11px;color:#a78bfa;font-weight:700;'>Rider "+(ri+1)+"</span>"
    +"<button class='btn-del' style='font-size:11px;padding:2px 8px;' onclick='remRider(\""+b.id+"\",\""+row.id+"\")'>âœ•</button></div>"
    // Row 1: Rider name + Premium
    +"<div class='g2' style='margin-bottom:"+(needsTerm?"10px":"0")+"'>"
    +"<div><label class='lbl' style='font-size:11px;'>Rider Name</label>"
    +"<select class='sel' style='font-size:12px;color:"+(row.name?"#e2e8f0":"#64748b")+";' onchange='updRiderName(\""+b.id+"\",\""+row.id+"\",this.value)'>"
    +"<option value=''>-- Select Rider --</option>"
    +avail.map(r=>"<option value='"+esc(r)+"'"+(row.name===r?" selected":"")+">"+esc(r)+"</option>").join("")
    +"</select></div>"
    +"<div><label class='lbl' style='font-size:11px;'>Annual Premium (SGD)</label>"
    +"<input class='inp rp-inp' style='font-size:12px;' type='number' data-pid='"+b.id+"' data-rid='"+row.id+"' value='"+esc(row.premium)+"' placeholder='e.g. 1200'/></div>"
    +"</div>";

    // Row 2: Rider term (only if multiple terms available)
    if(needsTerm){
      html+="<div><label class='lbl' style='font-size:11px;color:#a78bfa;'>ğŸ“† Rider Policy Term</label>"
      +"<select class='sel' style='font-size:12px;color:"+(row.riderTerm?"#e2e8f0":"#64748b")+";' onchange='updRiderTerm(\""+b.id+"\",\""+row.id+"\",this.value)'>"
      +"<option value=''>-- Select Rider Term --</option>"
      +rTerms.map(t=>"<option value='"+esc(t.l)+"'"+(row.riderTerm===t.l?" selected":"")+">"+esc(t.l)+" ("+t.y+"%)</option>").join("")
      +"</select></div>";
    }
    html+="</div>";
  });

  html+="</div>";

  // Preview
  if(selT&&ap>0){
    html+="<div class='prev-box'><div style='font-size:11px;color:#60a5fa;font-weight:700;margin-bottom:8px;'>âš¡ Preview â€” Policy "+(i+1)+"</div>"
    +"<div class='g3' style='margin-bottom:"+(hasR?8:0)+"px;'>"
    +"<div class='mc'><div class='ml'>Base Comm</div><div class='mv' style='color:#34d399;'>"+$f(bc)+"</div></div>"
    +"<div class='mc'><div class='ml'>Base Credits</div><div class='mv' style='color:#60a5fa;'>"+$c(bCr)+" pts</div></div>"
    +"<div class='mc'><div class='ml'>Comm %</div><div class='mv' style='color:#94a3b8;'>"+selT.y+"%</div></div>"
    +"</div>"
    +rC.filter(r=>r.name&&r.rp>0).map((r,ri)=>
      "<div style='margin-bottom:6px;'><div style='font-size:10px;color:#64748b;margin-bottom:4px;'>Rider "+(ri+1)+": "+esc(r.name)+(r.riderTerm?" ("+esc(r.riderTerm)+")":"")+"</div>"
      +"<div class='g3'>"
      +"<div class='mc'><div class='ml'>Comm</div><div class='mv' style='color:#a78bfa;'>"+$f(r.comm)+"</div></div>"
      +"<div class='mc'><div class='ml'>Credits</div><div class='mv' style='color:#a78bfa;'>"+$c(r.cred)+" pts</div></div>"
      +"<div class='mc'><div class='ml'>Comm %</div><div class='mv' style='color:#64748b;'>"+r.pct+"%</div></div>"
      +"</div></div>"
    ).join("")
    +(hasR?"<div style='border-top:1px solid #1e40af;padding-top:8px;' class='g2'>"
      +"<div class='mc'><div class='ml'>Total Comm</div><div class='mv' style='color:#34d399;font-size:14px;'>"+$f(bc+rComm)+"</div></div>"
      +"<div class='mc'><div class='ml'>Total Credits</div><div class='mv' style='color:#60a5fa;font-size:14px;'>"+$c(bCr+rCred)+" pts</div></div></div>":"")
    +"</div>";
  }
  html+="</div>";
  return html;
}

function grandTot(){
  let comm=0, cred=0;
  for(const b of pols){
    const def=PROD[b.product]; if(!def) continue;
    const t=def.terms.find(t=>t.l===b.term); if(!t) continue;
    const ap=parseFloat(b.ap)||0;
    comm+=ap*t.y/100; cred+=ap*t.c;
    for(const r of b.riders){
      const rd=getRiderRate(r.name, r.riderTerm);
      const rp=parseFloat(r.premium)||0;
      if(rd&&rp){ comm+=rp*rd.y/100; cred+=rp*rd.c; }
    }
  }
  return {comm,cred};
}

// â”€â”€ DASHBOARD â”€â”€
function renderDash(){
  const ys=sales.filter(s=>s.date.startsWith(String(selYear)));
  const qd=getQD(ys,activeQ);
  const nt=TIERS.find(t=>t.min>qd.tc);
  return "<div style='display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;'>"
  +"<div style='position:relative;' id='yrWrap'><button class='yr-btn' onclick='togYrDD()'>ğŸ“… "+selYear+" <span style='font-size:10px;opacity:0.7;'>â–¼</span></button>"
  +"<div class='yr-dd' id='yrDD' style='display:none;'>"+yearList().map(y=>"<button class='yr-opt' style='color:"+(y===selYear?"#fff":"#94a3b8")+";background:"+(y===selYear?"#0f766e":"transparent")+";' onclick='selYr("+y+")'>"+y+"</button>").join("")+"</div></div>"
  +"<div style='display:flex;gap:6px;flex:1;flex-wrap:wrap;'>"+Object.keys(QS).map(q=>"<button class='q-btn"+(activeQ===q?" active":"")+"' onclick='setQ(\""+q+"\")'>"+q+"</button>").join("")+"</div></div>"
  +"<div style='font-size:13px;color:#94a3b8;margin-bottom:16px;'>"+selYear+" Â· "+QS[activeQ].label+" Â· Bonus paid in <span style='color:#60a5fa;font-weight:700;'>"+QS[activeQ].payout+"</span></div>"
  // Orange total commission card
  +"<div style='background:linear-gradient(135deg,#7c2d12,#c2410c,#ea580c);border-radius:12px;padding:18px;border:1px solid #f97316;margin-bottom:12px;box-shadow:0 0 24px rgba(249,115,22,0.2);'>"
  +"<div style='font-size:12px;color:#fed7aa;'>ğŸ’¼ Total Commission Earned (Base + Riders)</div>"
  +"<div style='font-size:32px;font-weight:900;color:#fff;margin-top:4px;'>"+$f(qd.tm)+"</div>"
  +"<div style='font-size:12px;color:#fdba74;margin-top:4px;'>"+QS[activeQ].label+" Â· "+selYear+"</div>"
  +"</div>"
  // Bonuses side by side
  +"<div class='g2' style='margin-bottom:12px;'>"
  +"<div class='card'><div class='lbl'>ğŸ† Quarterly Bonus ("+qd.tier.bonus+"%)</div><div class='kpi' style='color:#a78bfa;'>"+$f(qd.qb)+"</div></div>"
  +"<div class='card'><div class='lbl'>ğŸ‰ Easy Bonus (25%)</div><div class='kpi' style='color:"+(qd.tm>=3000?"#f59e0b":"#64748b")+";'>"+(qd.tm>=3000?$f(qd.eb):"Not reached ($3,000 min)")+"</div></div>"
  +"</div>"
  // Credits full width
  +"<div style='background:linear-gradient(135deg,#0f3460,#1a4a7a,#1e5f8a);border-radius:12px;padding:16px;border:1px solid #2563eb;margin-bottom:12px;display:flex;align-items:center;gap:16px;'>"
  +"<div style='font-size:36px;line-height:1;'>ğŸª™</div>"
  +"<div><div style='font-size:12px;color:#93c5fd;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;'>Total Credits Earned</div>"
  +"<div style='font-size:30px;font-weight:900;color:#60a5fa;margin-top:2px;'>"+$c(qd.tc)+" <span style='font-size:16px;font-weight:600;color:#3b82f6;'>pts</span></div>"
  +"<div style='font-size:11px;color:#64748b;margin-top:2px;'>Resets every quarter</div></div>"
  +"</div>"
  // Payout card
  +"<div class='pay-card'>"
  +"<div style='font-size:13px;color:#94a3b8;'>ğŸš€ Total Bonus Payable in "+QS[activeQ].payout+"</div>"
  +"<div style='font-size:32px;font-weight:900;color:#fbbf24;margin-top:4px;'>"+$f(qd.tb)+"</div>"
  +"<div style='font-size:12px;color:#64748b;margin-top:4px;'>Quarterly Bonus "+$f(qd.qb)+" + Easy Bonus "+$f(qd.eb)+"</div></div>"
  // Tier progress
  +"<div class='card' style='margin-bottom:16px;'><div style='font-size:13px;font-weight:700;color:#60a5fa;margin-bottom:12px;'>ğŸ“Š Credit Tier Progress</div>"
  +TIERS.map(t=>{
    const isA=qd.tc>=t.min&&qd.tc<=t.max, isU=qd.tc>=t.min;
    return "<div style='display:flex;align-items:center;gap:10px;margin-bottom:8px;'>"
    +"<div class='t-dot' style='background:"+(isA?"#34d399":isU?"#1d4ed8":"#334155")+";'></div>"
    +"<div style='flex:1;font-size:12px;color:"+(isA?"#e2e8f0":isU?"#94a3b8":"#475569")+";'>"+t.label+" credits</div>"
    +"<div style='font-size:13px;font-weight:700;color:"+(isA?"#34d399":isU?"#60a5fa":"#475569")+";'>"+t.bonus+"% "+(isA?"â† YOU ARE HERE":"")+"</div></div>";
  }).join("")
  +(nt?"<div style='margin-top:10px;font-size:12px;color:#f59e0b;'>âš¡ Need <strong>"+$c(nt.min-qd.tc)+" more credits</strong> to reach "+nt.bonus+"% tier</div>":"")
  +"</div>"
  // Easy bonus progress bar
  +"<div class='card'><div style='font-size:13px;font-weight:700;color:#f59e0b;margin-bottom:8px;'>ğŸ‰ Easy Bonus Progress</div>"
  +"<div class='prog-wrap'><div class='prog-bar' style='width:"+Math.min(100,(qd.tm/3000)*100)+"%;background:linear-gradient(90deg,#f59e0b88,#f59e0b);'></div></div>"
  +"<div style='font-size:12px;color:#94a3b8;margin-top:6px;'>"+$f(qd.tm)+" / $3,000.00 "+(qd.tm>=3000?"âœ… Unlocked!":"Â· "+$f(3000-qd.tm)+" more to unlock")+"</div></div>";
}

function getQD(ys,q){
  const qs=ys.filter(s=>s.quarter===q);
  const tm=qs.reduce((a,s)=>a+s.totalComm,0);
  const bc=qs.reduce((a,s)=>a+s.baseComm,0);
  const tc=qs.reduce((a,s)=>a+s.totalCredit,0);
  const tier=getTier(tc);
  const eb=tm>=3000?tm*0.25:0;
  const qb=tm*tier.bonus/100;
  return {tm,bc,tc,tier,eb,qb,tb:eb+qb};
}

// â”€â”€ HISTORY â”€â”€
function renderHist(){
  return "<div style='font-size:16px;font-weight:700;margin-bottom:16px;color:#60a5fa;'>ğŸ“‹ All Sales ("+sales.length+")</div>"
  +(sales.length===0?"<div style='text-align:center;color:#64748b;padding:40px;'>No sales logged yet.</div>"
  :sales.map(s=>{
    const dt=new Date(s.date+"T00:00:00").toLocaleDateString("en-SG",{day:"2-digit",month:"short",year:"numeric"});
    return "<div class='hist-item'>"
    +"<div style='display:flex;justify-content:space-between;align-items:flex-start;'>"
    +"<div style='flex:1;'>"
    +"<div style='display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:4px;'>"
    +"<span style='font-weight:700;font-size:15px;'>"+esc(s.clientName)+"</span>"
    +"<span class='badge'>"+s.quarter+"</span>"
    +"<span style='font-size:11px;color:#64748b;'>"+dt+"</span></div>"
    +"<div style='display:flex;gap:16px;flex-wrap:wrap;margin-bottom:8px;'>"
    +"<span style='font-size:12px;'>Base Comm: <strong style='color:#38bdf8;'>"+$f(s.baseComm)+"</strong></span>"
    +"<span style='font-size:12px;'>Total Comm: <strong style='color:#34d399;'>"+$f(s.totalComm)+"</strong></span>"
    +"<span style='font-size:12px;'>Credits: <strong style='color:#60a5fa;'>"+$c(s.totalCredit)+"</strong></span>"
    +"<span style='font-size:12px;color:#64748b;'>"+s.policies.length+" polic"+(s.policies.length>1?"ies":"y")+"</span></div>"
    +"</div><button class='btn-del' onclick='doDelSale(\""+s.fid+"\")'>âœ•</button></div>"
    +s.policies.map((p,pi)=>"<div class='pol-row'>"
      +"<div style='font-size:12px;color:#93c5fd;font-weight:600;margin-bottom:4px;'>Policy "+(pi+1)+": "+esc(p.product)+" Â· "+esc(p.term)+"</div>"
      +"<div style='display:flex;gap:12px;flex-wrap:wrap;font-size:11px;margin-bottom:6px;'>"
      +"<span>Premium: <strong style='color:#e2e8f0;'>"+$f(p.annualPremium)+"</strong></span>"
      +"<span>Base Comm: <strong style='color:#38bdf8;'>"+$f(p.baseComm)+"</strong></span>"
      +"<span>Total Comm: <strong style='color:#34d399;'>"+$f(p.totalComm)+"</strong></span>"
      +"<span>Credits: <strong style='color:#60a5fa;'>"+$c(p.totalCredit)+"</strong></span></div>"
      +(p.riders&&p.riders.length>0
        ?"<div style='display:flex;flex-direction:column;gap:5px;'>"
        +p.riders.map(r=>
          "<div style='background:#0f172a;border-radius:8px;padding:7px 12px;border:1px solid #4f46e5;display:flex;flex-wrap:wrap;align-items:center;gap:8px;'>"
          +"<span style='font-size:11px;color:#a78bfa;font-weight:700;'>ğŸ”— "+esc(r.name)+"</span>"
          +(r.commPct?"<span style='font-size:10px;color:#64748b;'>("+r.commPct+"%)</span>":"")
          +"<span style='font-size:11px;color:#64748b;'>Â·</span>"
          +"<span style='font-size:11px;'>Premium: <strong style='color:#e2e8f0;'>"+$f(r.premium)+"</strong></span>"
          +"<span style='font-size:11px;color:#64748b;'>Â·</span>"
          +"<span style='font-size:11px;'>Comm: <strong style='color:#a78bfa;'>"+$f(r.comm)+"</strong></span>"
          +"<span style='font-size:11px;color:#64748b;'>Â·</span>"
          +"<span style='font-size:11px;'>Credits: <strong style='color:#a78bfa;'>"+$c(r.credit)+" pts</strong></span>"
          +"</div>"
        ).join("")+"</div>"
        :"")
      +"</div>"
    ).join("")
    +"</div>";
  }).join(""));
}

// â”€â”€ IGNITE â”€â”€
function renderIgnite(){
  const ig=sales.filter(s=>{const m=new Date(s.date+"T00:00:00").getMonth();return s.date.startsWith("2026")&&m<=4;});
  const ic=ig.reduce((a,s)=>a+s.baseComm,0);
  const pct=Math.min(100,(ic/30000)*100);
  return "<div class='camp-card'><div class='camp-hdr'>"
  +"<div style='font-size:18px;font-weight:800;color:#60a5fa;'>ğŸ”¥ Ignite 2026</div>"
  +"<div style='font-size:13px;color:#94a3b8;margin-top:2px;'>âœˆï¸ Hangzhou, China ğŸ‡¨ğŸ‡³ Â· ğŸ“† Jan â€“ May 2026</div></div>"
  +"<div style='padding:20px;'>"
  +"<div style='font-size:13px;color:#94a3b8;margin-bottom:16px;line-height:1.6;'>Hit <strong style='color:#34d399;'>$30,000</strong> in base commissions between January and May 2026.<br><span style='font-size:12px;color:#64748b;'>Base commissions only â€” bonuses do not count.</span></div>"
  +"<div class='g2' style='margin-bottom:16px;'>"
  +"<div class='card-dark'><div style='font-size:12px;color:#94a3b8;'>Base Comm (Janâ€“May)</div><div style='font-size:24px;font-weight:900;color:#34d399;margin-top:4px;'>"+$f(ic)+"</div></div>"
  +"<div class='card-dark'><div style='font-size:12px;color:#94a3b8;'>Still Needed</div><div style='font-size:24px;font-weight:900;color:"+(ic>=30000?"#34d399":"#f87171")+";margin-top:4px;'>"+(ic>=30000?"âœ… Qualified!":$f(30000-ic))+"</div></div></div>"
  +"<div style='display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin-bottom:4px;'><span>Progress to $30,000</span><span>"+pct.toFixed(1)+"%</span></div>"
  +"<div class='prog-wrap'><div class='prog-bar' style='width:"+pct+"%;background:linear-gradient(90deg,#34d39988,#34d399);'></div></div>"
  +(ic>=30000?"<div style='background:linear-gradient(135deg,#064e3b,#065f46);border-radius:10px;padding:14px;border:1px solid #059669;text-align:center;margin-top:12px;'><div style='font-size:14px;font-weight:700;color:#34d399;'>ğŸ‰ Congratulations! Qualified for Hangzhou!</div></div>":"")
  +"</div></div>";
}

// â”€â”€ TRAILBLAZER â”€â”€
function renderTrail(){
  const tr=sales.filter(s=>s.date.startsWith("2026"));
  const tc=tr.reduce((a,s)=>a+s.baseComm,0);
  const tiers=[{target:75000,label:"1 Ticket ğŸ«",color:"#f59e0b"},{target:150000,label:"2 Tickets ğŸ«ğŸ«",color:"#a78bfa"}];
  return "<div class='camp-card'><div class='camp-hdr'>"
  +"<div style='font-size:18px;font-weight:800;color:#60a5fa;'>ğŸŒ Trailblazer 2027</div>"
  +"<div style='font-size:13px;color:#94a3b8;margin-top:2px;'>âœˆï¸ South Africa ğŸ‡¿ğŸ‡¦ Â· ğŸ“† Jan â€“ Dec 2026</div></div>"
  +"<div style='padding:20px;'>"
  +"<div style='font-size:13px;color:#94a3b8;margin-bottom:16px;line-height:1.6;'>Earn your way to South Africa based on full-year 2026 base commissions.<br><span style='font-size:12px;color:#64748b;'>Base commissions only â€” bonuses do not count.</span></div>"
  +tiers.map(tier=>{
    const q=tc>=tier.target, p=Math.min(100,(tc/tier.target)*100);
    return "<div style='background:#0f172a;border-radius:12px;padding:16px;border:1px solid "+(q?"#059669":"#334155")+";margin-bottom:14px;'>"
    +"<div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;'>"
    +"<div style='font-size:14px;font-weight:700;color:"+tier.color+";'>South Africa "+tier.label+"</div>"
    +"<div style='font-size:12px;font-weight:700;background:"+(q?"#064e3b":"#1e293b")+";color:"+(q?"#34d399":"#64748b")+";padding:3px 10px;border-radius:6px;border:1px solid "+(q?"#059669":"#334155")+";'>"+(q?"âœ… Qualified":"Not Yet")+"</div></div>"
    +"<div class='g2' style='margin-bottom:10px;'>"
    +"<div><div style='font-size:11px;color:#64748b;'>Target</div><div style='font-size:16px;font-weight:700;'>"+$f(tier.target)+"</div></div>"
    +"<div><div style='font-size:11px;color:#64748b;'>"+(q?"Exceeded by":"Still Needed")+"</div><div style='font-size:16px;font-weight:700;color:"+(q?"#34d399":"#f87171")+";'>"+(q?$f(tc-tier.target):$f(tier.target-tc))+"</div></div></div>"
    +"<div class='prog-wrap'><div class='prog-bar' style='width:"+p+"%;background:linear-gradient(90deg,"+tier.color+"88,"+tier.color+");'></div></div>"
    +"</div>";
  }).join("")
  +"<div class='card-dark'><div style='font-size:12px;color:#94a3b8;margin-bottom:4px;'>Total Base Comm (Full Year 2026)</div>"
  +"<div style='font-size:28px;font-weight:900;color:#60a5fa;'>"+$f(tc)+"</div></div>"
  +"</div></div>";
}

// â”€â”€ Confetti â”€â”€
function launchConfetti(){
  const cv=document.getElementById("confetti");
  cv.style.display="block"; cv.width=window.innerWidth; cv.height=window.innerHeight;
  const ctx=cv.getContext("2d");
  const cols=["#34d399","#60a5fa","#fbbf24","#a78bfa","#f87171","#38bdf8","#fb923c"];
  const pieces=Array.from({length:180},()=>({
    x:Math.random()*cv.width, y:-10-Math.random()*200,
    w:8+Math.random()*8, h:5+Math.random()*5,
    color:cols[Math.floor(Math.random()*cols.length)],
    angle:Math.random()*360, spin:(-1+Math.random()*2)*4,
    vx:(-1+Math.random()*2)*3, vy:3+Math.random()*5, op:1
  }));
  let fr=0;
  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    pieces.forEach(p=>{
      ctx.save(); ctx.globalAlpha=p.op; ctx.translate(p.x,p.y);
      ctx.rotate(p.angle*Math.PI/180); ctx.fillStyle=p.color;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
      p.x+=p.vx; p.y+=p.vy; p.angle+=p.spin; p.vy+=0.07;
      if(fr>80) p.op-=0.018;
    });
    fr++;
    if(fr<140) requestAnimationFrame(draw);
    else{ ctx.clearRect(0,0,cv.width,cv.height); cv.style.display="none"; }
  }
  draw();
}

// â”€â”€ Event listeners â”€â”€
function attachAll(){
  // Client name
  const ci=document.getElementById("clientInp");
  if(ci) ci.addEventListener("input",e=>{ fClient=e.target.value; });

  // Date input
  const di=document.getElementById("dateInp");
  if(di) di.addEventListener("input",e=>{
    fDate=e.target.value;
    if(/^\d{4}-\d{2}-\d{2}$/.test(fDate)){
      const dt=new Date(fDate+"T00:00:00");
      if(!isNaN(dt)){ calY=dt.getFullYear(); calM=dt.getMonth(); }
      renderLog(); attachAll();
    }
  });

  // Calendar icon
  const ci2=document.getElementById("calIco");
  if(ci2) ci2.addEventListener("click",e=>{
    e.stopPropagation(); calOpen=!calOpen;
    if(calOpen&&fDate){ calY=parseInt(fDate.split("-")[0]); calM=parseInt(fDate.split("-")[1])-1; }
    renderLog(); attachAll();
  });

  // Annual premium â€” update on input, rebuild preview on blur
  document.querySelectorAll(".pp-inp").forEach(inp=>{
    inp.addEventListener("input",e=>{
      const pid=e.target.dataset.pid;
      pols=pols.map(p=>p.id===pid?{...p,ap:e.target.value}:p);
    });
    inp.addEventListener("blur",e=>{
      const pid=e.target.dataset.pid;
      pols=pols.map(p=>p.id===pid?{...p,ap:e.target.value}:p);
      renderLog(); attachAll();
    });
  });

  // Rider premium â€” update on input, rebuild on blur
  document.querySelectorAll(".rp-inp").forEach(inp=>{
    inp.addEventListener("input",e=>{
      const pid=e.target.dataset.pid, rid=e.target.dataset.rid;
      pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.map(r=>r.id===rid?{...r,premium:e.target.value}:r)}:p);
    });
    inp.addEventListener("blur",e=>{
      const pid=e.target.dataset.pid, rid=e.target.dataset.rid;
      pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.map(r=>r.id===rid?{...r,premium:e.target.value}:r)}:p);
      renderLog(); attachAll();
    });
  });

  // Close dropdowns on outside click
  document.addEventListener("mousedown",function h(e){
    const cw=document.getElementById("calWrap");
    if(calOpen&&cw&&!cw.contains(e.target)){ calOpen=false; renderLog(); attachAll(); }
    let changed=false;
    Object.keys(srch).forEach(pid=>{
      if(srch[pid]&&srch[pid].open){
        const el=document.getElementById("srch-"+pid);
        if(el&&!el.contains(e.target)){ srch[pid]={open:false,query:""}; changed=true; }
      }
    });
    if(changed){ renderLog(); attachAll(); }
    const yw=document.getElementById("yrWrap"), yd=document.getElementById("yrDD");
    if(yd&&yw&&!yw.contains(e.target)) yd.style.display="none";
  },{once:true});
}

// â”€â”€ Window handlers â”€â”€
window.setTab=t=>{ tab=t; if(t!=="log") document.getElementById("app").innerHTML=""; renderAll(); };
window.setQ=q=>{ activeQ=q; document.getElementById("app").innerHTML=renderDash(); attachAll(); };
window.selYr=y=>{ selYear=y; document.getElementById("app").innerHTML=renderDash(); attachAll(); };
window.togYrDD=()=>{ const d=document.getElementById("yrDD"); if(d) d.style.display=d.style.display==="none"?"block":"none"; };
window.navM=dir=>{ calM+=dir; if(calM<0){calM=11;calY--;}else if(calM>11){calM=0;calY++;} renderLog(); attachAll(); };
window.jumpY=y=>{ calY=y; renderLog(); attachAll(); };
window.pickDay=d=>{ fDate=calY+"-"+String(calM+1).padStart(2,"0")+"-"+String(d).padStart(2,"0"); calOpen=false; renderLog(); attachAll(); };
window.pickToday=()=>{ fDate=todayStr(); calOpen=false; const t=new Date(); calY=t.getFullYear(); calM=t.getMonth(); renderLog(); attachAll(); };

window.srchOpen=pid=>{ srch[pid]={open:true,query:""}; renderLog(); attachAll(); setTimeout(()=>document.getElementById("sinp-"+pid)?.focus(),30); };
window.srchType=(pid,val)=>{ srch[pid]={open:true,query:val}; renderLog(); attachAll(); setTimeout(()=>{ const i=document.getElementById("sinp-"+pid); if(i){i.focus();i.setSelectionRange(val.length,val.length);}},10); };
window.srchPick=(pid,val)=>{ srch[pid]={open:false,query:""}; pols=pols.map(p=>p.id===pid?{...p,product:val,term:"",ap:"",riders:[]}:p); renderLog(); attachAll(); };
window.srchKey=(e,pid)=>{ if(e.key==="Escape"){srch[pid]={open:false,query:""}; renderLog(); attachAll();} };

window.addPol=()=>{ pols.push(newPol()); renderLog(); attachAll(); };
window.remPol=id=>{ srch[id]=null; pols=pols.filter(p=>p.id!==id); renderLog(); attachAll(); };
window.updPolF=(id,f,v)=>{ pols=pols.map(p=>p.id===id?{...p,[f]:v}:p); renderLog(); attachAll(); };

window.addRider=id=>{
  pols=pols.map(p=>{
    if(p.id!==id) return p;
    const def=PROD[p.product]; if(!def||!def.riders) return p;
    const chosen=p.riders.map(r=>r.name).filter(Boolean);
    const next=def.riders.find(r=>!chosen.includes(r));
    if(!next) return p;
    return {...p,riders:[...p.riders,newRider()]};
  });
  renderLog(); attachAll();
};
window.remRider=(pid,rid)=>{ pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.filter(r=>r.id!==rid)}:p); renderLog(); attachAll(); };

// Separate handlers for rider name and rider term
window.updRiderName=(pid,rid,val)=>{
  pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.map(r=>r.id===rid?{...r,name:val,riderTerm:""}:r)}:p);
  renderLog(); attachAll();
};
window.updRiderTerm=(pid,rid,val)=>{
  pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.map(r=>r.id===rid?{...r,riderTerm:val}:r)}:p);
  renderLog(); attachAll();
};
window.updRider=(pid,rid,f,v)=>{
  pols=pols.map(p=>p.id===pid?{...p,riders:p.riders.map(r=>r.id===rid?{...r,[f]:v}:r)}:p);
  renderLog(); attachAll();
};

window.doAddSale=async()=>{
  const ci=document.getElementById("clientInp");
  if(ci) fClient=ci.value.trim();
  if(!fClient||!fDate||!pols.some(b=>b.product&&b.term&&b.ap)) return;
  const mo=new Date(fDate+"T00:00:00").getMonth();
  const saved=pols.filter(b=>b.product&&b.term&&b.ap).map(b=>{
    const def=PROD[b.product]; const t=def.terms.find(t=>t.l===b.term);
    const ap=parseFloat(b.ap)||0;
    const baseComm=ap*t.y/100, baseCred=ap*t.c;
    const riders=b.riders.filter(r=>r.name&&parseFloat(r.premium)>0).map(r=>{
      const rd=getRiderRate(r.name,r.riderTerm);
      const rp=parseFloat(r.premium)||0;
      return {name:r.name,riderTerm:r.riderTerm,premium:rp,commPct:rd?rd.y:0,comm:rd?rp*rd.y/100:0,credit:rd?rp*rd.c:0};
    });
    const rC=riders.reduce((a,r)=>a+r.comm,0), rCr=riders.reduce((a,r)=>a+r.credit,0);
    return {product:b.product,term:b.term,annualPremium:ap,commPct:t.y,baseComm,baseCred,riders,totalComm:baseComm+rC,totalCredit:baseCred+rCr};
  });
  const obj={
    date:fDate,clientName:fClient,policies:saved,
    totalComm:saved.reduce((a,p)=>a+p.totalComm,0),
    baseComm:saved.reduce((a,p)=>a+p.baseComm,0),
    totalCredit:saved.reduce((a,p)=>a+p.totalCredit,0),
    quarter:getQ(mo),month:mo
  };
  await addSaleDB(obj);
  launchConfetti();
  fClient=""; pols=[newPol()]; srch={};
  tab="dashboard";
  renderAll();
};
window.doDelSale=async id=>{ if(confirm("Delete this sale?")) await delSaleDB(id); };

renderAll();
</script>
</body>
</html>
